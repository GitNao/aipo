<html>
<head>
<script type="text/javascript" src="/container/gadgets/js/core:rpc:jquery.js?c=0"></script>
<script type="text/javascript">

var retryCount = null;
function join() {
    var params = {
       url: "push/",
       timeout: 10 * 60 * 1000,//(m・sec)デバッグ時には2000ぐらいに設定
       cache: false,
       contentType: "application/javascript",
       success: function(data, status) {
           var type = data.type;
           if("messagev2" == type) {
        	   //クライアント側がメッセージを受信
               gadgets.rpc.call(null, "requestCheckMessage", null, data);
        	   console.log("you recived a message");
               retryCount = 0;
           }
           if("messagev2_read" == type) {
        	   //クライアント側が送ったメッセージが受け取られたよという通知
               gadgets.rpc.call(null, "requestCheckMessageRead", null, data);
               retryCount = 0;
           }
           if("activity" == type) {
               gadgets.rpc.call(null, "requestCheckActivity");
               retryCount = 0;
           }
           join();
       },
       error: function(data, status) {
           if(retryCount < 10) {
               retryCount++;
        	   console.log("retryCount is " + retryCount);
               join();
           }else{
        	   console.log("retry is stopped");
               retryCount = 101;//諦めたよフラグ
           }
       }
    }
    jQuery.ajax(params);
}

function init() {
    gadgets.rpc.call(null, "requestCheckActivity");
	var push = gadgets.util.getUrlParameters()['push'];
	if(push == 1) {
		retryCount = 0;
        join();
	}
    return false;
}

function reload(){
	if(retryCount > 100) {
		console.log("retryCount is restarted");
		init();
	}
	return false;
}

gadgets.util.registerOnLoadHandler(init);

</script>
</head>
<body>
	<script type="text/javascript">gadgets.util.runOnLoadHandlers();</script>
</body>
</html>