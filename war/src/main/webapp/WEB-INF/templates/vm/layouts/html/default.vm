#*
 * Aipo is a groupware program developed by Aimluck,Inc.
 * Copyright (C) 2004-2011 Aimluck,Inc.
 * http://www.aipo.com
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *#

## ---------------------------------------------------------------------------
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
<base href="$clink.External" ></base>
<meta http-equiv="Content-Language" content="ja" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
#if($config.getString("portal.title"))#set($titlePrefix = $config.getString("portal.title"))#else#set($titlePrefix = "")#end
<title>${alias}</title>
<meta name="description" content="" />
<meta name="keywords" content="" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta name="copyright" content="${copyright}" />
<meta http-equiv="X-UA-Compatible" content="IE=emulateIE7,chrome=1" />
<meta name="robots" content="noindex,follow" />
<link type="image/x-icon" rel="shortcut icon" href="${external_resources_url}/images/favicon.ico" />
<link type="image/x-icon" rel="icon" href="${external_resources_url}/images/favicon.ico" />
<link rel="stylesheet" type="text/css" href="${external_resources_url}/themes/${theme}/css/extend.css" media="screen,tv,print" />
<link rel="stylesheet" type="text/css" href="${external_resources_url}/themes/${theme}/css/common.css" media="screen,tv,print" />
<link rel="stylesheet" type="text/css" href="${external_resources_url}/themes/${theme}/css/print.css" media="print" />
#if($isXDomain == "true")
<script type="text/javascript">
  djConifg = {
    xDomainBasePath: '${external_resources_url}/javascript'
  };
</script>
<script language="JavaScript" type="text/javascript" src="${external_resources_url}/javascript/dojo/dojo.xd.js"></script>
<script language="JavaScript" type="text/javascript" src="${external_resources_url}/javascript/aipo.xd.js"></script>
#else
<script language="JavaScript" type="text/javascript" src="${external_resources_url}/javascript/dojo/dojo.js"></script>
<script language="JavaScript" type="text/javascript" src="${external_resources_url}/javascript/aipo.js"></script>
#end
<script type="text/javascript" src="${unlockeddomain_url}/gadgets/js/core:rpc:shindig-container.js?c=1"></script>
<script type="text/javascript" src="${external_resources_url}/javascript/aipo/container.js"></script>
<script type="text/javascript" src="${external_resources_url}/javascript/aipo/customize/form.js"></script>
</head>
<body onload="aipo.container.renderGadgets()">
<!-- WRAPPER -->
<div id="wrapper">
  <table class="tableWrapper">
    <tbody>
      <tr>
        <td class="wide top">
          <div id="roundTop" class="clearfix">
            <div id="roundRight">
              <div id="roundBottom">
                <div id="roundLeft">
                  <div id="roundTopLeft">
                    <div id="roundTopRight">
                      <div id="roundBottomRight">
                        <div id="roundBottomLeft">
                          <div id="roundWrapper">

$!jnavigation.setTemplate($config.getString("topnav.vm"))
$screen_placeholder
#if ($config.getBoolean("bottomnav.enable") == true)
$!jnavigation.setTemplate($config.getString("bottomnav.vm"))
#end

                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>
<!-- /WRAPPER -->
<div id="modalDialog" class="modalDialog" style="display:none"></div>
<script language="JavaScript" type="text/javascript">
//<![CDATA[

dojo.require("aimluck.widget.Dialog");

dojo.addOnLoad(function() {
    var params = {
        widgetId:'modalDialog'
    };
    new aimluck.widget.Dialog(params, "modalDialog");
    //dojo.disconnect(dojo, "loaded", "_dialog");
#if ($data.User.hasLoggedIn())
    gadgets.rpc.setRelayUrl("sharedStateIframe", "$relayUrl");
    gadgets.rpc.setAuthToken("sharedStateIframe", "$rpctoken");
    dojo.byId('sharedStateIframe').src='$checkUrl';
#end
});

#if (${client} != "IPAD")
dojo.require("dojo.dnd.Source");

dojo.addOnLoad(function() {
    dojo.query('.customizeMenuIcon').forEach(function(element) {
        dojo.connect(element, 'onmouseenter', null, function(){
            dojo.addClass(this, 'customizeMenuIconMouseenter');
        });
        dojo.connect(element, 'onmouseleave', null, function(){
            dojo.removeClass(this, 'customizeMenuIconMouseenter');
        });
    });

    var handle = dojo.connect(dojo.query('body')[0], 'onclick', null, function(){
        if (dojo.query('.customizeMenuIconMouseenter').length == 0) {
            aipo.customize.hideMenu();
        }
    });
        
    var containers = dojo.query('.container');
    var containerSources = [];
    for(var c = 0; c < containers.length ; c++){
        var container = new dojo.dnd.Source(containers[c], {
            withHandles: true,
            copyOnly: false
        });
        containerSources.push(container);
    }
    

    for(var c = 0; c < containers.length ; c++){
        dojo.connect(containerSources[c], "onDndStart", containers[c], function(){
            dojo.addClass(this, 'dojoDndContainerItemOver');
            aipo.customize.hideMenu();
        });

        dojo.connect(containerSources[c], "onDndCancel", containers[c], function(){
            dojo.removeClass(this, 'dojoDndContainerItemOver');
        });

        dojo.connect(container, "onDndDrop", containerSources[c], function(source, nodes, copy, target){
            if (this == target) {
                if (copy) {
                    nodes.orphan();
                }
                var params = '';
                var cols = dojo.query('.container');
                for(var c = 0; c < cols.length ; c++){
                    var rows = dojo.query('.dojoDndItem .roundBlockContent > div', cols[c]);
                    var reverse = false;
                    if (rows.length >= 2) {
                        var top = rows[0];
                        var bottom = rows[rows.length - 1];
                        while (top && bottom && top.offsetTop == bottom.offsetTop) {
                            top = top.offsetParent;
                            bottom = bottom.offsetParent;
                        }
                        if (top.offsetTop > bottom.offsetTop) {
                            reverse = true;
                        }
                    }
                    for (var r = 0 ; r < rows.length ; r++) {
                        var pid = rows[r].id.split("portlet_")[1];
                        if (reverse) {
                            params = params + '&' + pid + '_row=' + (rows.length - r - 1);
                        } else {
                            params = params + '&' + pid + '_row=' + r;
                        }
                        params = params + '&' + pid + '_col=' + c;
                    }
                }
                
                url = "$!jslink.getPage().addQueryData('template', 'CustomizeFormJSONScreen').addQueryData('mode', 'layout')" + params;
                aipo.customize.submit(url, '$!portlet.ID', function(){
                });
                
                var iframe = dojo.query('.gadgets-gadget-content iframe', nodes[0]);
                if(iframe && iframe.length == 1) {
                  var pid = iframe[0].id.split("remote_iframe_")[1].split("_NN_")[0];
                  var gadgets_ = aipo.container.gadgets_;
                  for(var i in gadgets_) {
                     var gadget = gadgets_[i];
                     if(gadget.portletId == pid) {
                       aipo.container.renderGadget(gadget);
                       break;
                     }
                  }
                }
                
                dojo.removeClass(this.node, 'dojoDndContainerItemOver');
            }
        });
    }
    
    var underlay = new aimluck.widget.DialogUnderlay({ templateString: "<div class=modalDialogUnderlayWrapper id='${id}_underlay'><div dojoAttachPoint='node'></div></div>" });
    dojo.connect(underlay.domNode, "onmousemove", underlay.domNode, function(){
        underlay.hide();
    });
    underlay.show();
});
#end

//]]>
</script>
<iframe id="sharedStateIframe" name="sharedStateIframe" src="about:blank" frameborder="no" scrolling="no" width="0" height="0"></iframe>
#ALjavascript("javascript/aipo/schedule/form.js")
#ALjavascript("javascript/aipo/workflow/form.js")
#ALjavascript("javascript/aipo/blog/form.js")
#ALjavascript("javascript/aipo/msgboard/form.js")
#ALjavascript("javascript/aipo/note/form.js")
</body>
</html>
